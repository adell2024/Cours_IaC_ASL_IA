---
# ansible/playbooks/03-init-master.yml
# Initialisation du master Kubernetes

- name: Initialiser le master Kubernetes
  hosts: masters
  become: yes
  tasks:
    - name: Vérifier si le cluster est déjà initialisé
      stat:
        path: /etc/kubernetes/admin.conf
      register: kubeadm_init

    - name: Initialiser kubeadm sur le master
      shell: |
        kubeadm init \
          --pod-network-cidr=10.244.0.0/16 \
          --apiserver-advertise-address={{ ansible_eth1.ipv4.address }} \
          --control-plane-endpoint={{ ansible_eth1.ipv4.address }}
      when: not kubeadm_init.stat.exists
      register: kubeadm_output

    - name: Créer le répertoire .kube pour l'utilisateur ubuntu
      file:
        path: /home/ubuntu/.kube
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Copier admin.conf vers .kube/config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/ubuntu/.kube/config
        remote_src: yes
        owner: ubuntu
        group: ubuntu
        mode: '0600'

    - name: Installer le réseau Flannel (CNI)
      become_user: ubuntu
      shell: kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
      args:
        creates: /var/lib/cni/flannel

    - name: Générer le token de jointure pour les workers
      shell: kubeadm token create --print-join-command
      register: join_command
      changed_when: false

    - name: Sauvegarder la commande de jointure
      set_fact:
        k8s_join_command: "{{ join_command.stdout }}"
      delegate_to: localhost
      delegate_facts: true

    - name: Afficher la commande de jointure
      debug:
        msg: "{{ join_command.stdout }}"

    - name: Sauvegarder la commande dans un fichier local
      local_action:
        module: copy
        content: "{{ join_command.stdout }}"
        dest: /tmp/k8s_join_command.sh
      become: no

    - name: Attendre que tous les nodes du control plane soient prêts
      become_user: ubuntu
      shell: kubectl get nodes | grep -w "Ready" | grep -w "control-plane"
      register: control_plane_ready
      until: control_plane_ready.rc == 0
      retries: 20
      delay: 10
      changed_when: false
